<?php

/**
 * @file
 * Integrates Drupal Commerce with MailChimp eCommerce.
 */

/**
 * Begins a batch process to add existing Commerce products to MailChimp.
 */
function mailchimp_ecommerce_commerce_batch_add_existing_products() {
  $batch = [
    'title' => t('Adding products to MailChimp'),
    'operations' => [],
  ];

  $query = \Drupal::entityQuery('commerce_product');
  $result = $query->execute();

  if (!empty($result)) {
    $product_ids = array_keys($result);

    foreach ($product_ids as $product_id) {
      $batch['operations'][] = [
        'mailchimp_ecommerce_commerce_batch_add_product',
        [
          $product_id,
        ],
      ];
    }
  }

  batch_set($batch);
}

/**
 * Batch callback used to add a product to MailChimp.
 */
function mailchimp_ecommerce_commerce_batch_add_product($product_id, &$context) {
  /** @var Drupal\commerce_product\Entity\Product $product */
  $product = \Drupal\commerce_product\Entity\Product::load($product_id);

  $title = (!empty($product->get('title')->value)) ? $product->get('title')->value : '';
  $description = (!empty($product->get('body')->value)) ? $product->get('body')->value : '';
  $type = (!empty($product->get('type')->value)) ? $product->get('type')->value : '';

  /** @var \Drupal\mailchimp_ecommerce\ProductHandler $product_handler */
  $product_handler = \Drupal::service('mailchimp_ecommerce.product_handler');

  $variants = $product_handler->buildProductVariants($product);

  $product_handler->addProduct($product_id, $title, $description, $type, $variants);
}

/**
 * Implements hook_default_rules_configuration().
 */
function mailchimp_ecommerce_commerce_default_rules_configuration() {
  $rules = [];

  // Add a reaction rule to display the default Add to Cart message.
  $rule = rules_reaction_rule();

  $rule->label = t('Send cart to MailChimp');
  $rule->tags = ['Commerce Cart'];
  $rule->active = TRUE;

  $rule
    ->event('commerce_cart_product_add')
    ->event('commerce_cart_product_remove')
    ->action('mailchimp_ecommerce_commerce_send_cart', [
      'commerce_order:select' => 'commerce-order',
    ]);

  $rules['mailchimp_ecommerce_commerce_send_cart'] = $rule;

  return $rules;
}

/**
 * Implements hook_rules_action_info().
 */
function mailchimp_ecommerce_commerce_rules_action_info() {
  $actions = [];

  $actions['mailchimp_ecommerce_commerce_send_cart'] = [
    'label' => t('Send a cart to MailChimp'),
    'parameter' => [
      'commerce_order' => [
        'type' => 'commerce_order',
        'label' => t('Order to send'),
      ],
    ],
    'group' => t('Commerce Order'),
    'callbacks' => [
      'execute' => '_mailchimp_ecommerce_commerce_send_cart',
    ],
  ];

  return $actions;
}

/**
 * Parses an address from a Commerce customer profile.
 *
 * @param object $customer_profile_wrapper
 *   Commerce customer profile object.
 *
 * @return object
 *   Address object in a MailChimp-friendly format.
 */
function mailchimp_ecommerce_commerce_parse_customer_profile_address($customer_profile_wrapper) {
  $address = [];

  if (isset($customer_profile_wrapper->commerce_customer_address->thoroughfare) &&
    isset($customer_profile_wrapper->commerce_customer_address->premise) &&
    isset($customer_profile_wrapper->commerce_customer_address->locality) &&
    isset($customer_profile_wrapper->commerce_customer_address->administrative_area) &&
    isset($customer_profile_wrapper->commerce_customer_address->postal_code) &&
    isset($customer_profile_wrapper->commerce_customer_address->country)
  ) {
    $address = (object) [
      'address1' => $customer_profile_wrapper->commerce_customer_address->thoroughfare->value(),
      'address2' => $customer_profile_wrapper->commerce_customer_address->premise->value(),
      'city' => $customer_profile_wrapper->commerce_customer_address->locality->value(),
      'province_code' => $customer_profile_wrapper->commerce_customer_address->administrative_area->value(),
      'postal_code' => $customer_profile_wrapper->commerce_customer_address->postal_code->value(),
      'country_code' => $customer_profile_wrapper->commerce_customer_address->country->value(),
    ];
  }

  return $address;
}
