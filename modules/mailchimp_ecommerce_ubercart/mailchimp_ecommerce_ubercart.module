<?php

/**
 * @file
 * Integrates Ubercart with MailChimp eCommerce.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function mailchimp_ecommerce_ubercart_form_mailchimp_ecommerce_admin_settings_alter(&$form, &$form_state) {
  $form['mailchimp_ecommerce_integration']['#options']['ubercart'] = t('Ubercart');

  // Add submit handler as first element in submit array.
  array_unshift($form['#submit'], 'mailchimp_ecommerce_ubercart_integration_admin_settings_submit');
}

/**
 * Submit handler for the MailChimp eCommerce settings form.
 */
function mailchimp_ecommerce_ubercart_integration_admin_settings_submit($form, &$form_state) {
  // TODO: Create store ID.
}

/**
 * Implements hook_node_insert().
 */
function mailchimp_ecommerce_ubercart_node_insert($node) {
  if ($node->type == 'product') {
    // Create a corresponding MailChimp product.
    $product = mailchimp_ecommerce_ubercart_get_product_values_from_node($node);

    mailchimp_ecommerce_add_product(
      $product['id'],
      $product['variant_id'],
      $product['title'],
      $product['description'],
      $product['type'],
      $product['sku'],
      $product['price']);
  }
}

/**
 * Implements hook_node_update().
 */
function mailchimp_ecommerce_ubercart_node_update($node) {
  if ($node->type == 'product') {
    // Update the corresponding MailChimp product.
    $product = mailchimp_ecommerce_ubercart_get_product_values_from_node($node);

    mailchimp_ecommerce_add_product(
      $product['id'],
      $product['variant_id'],
      $product['title'],
      $product['description'],
      $product['type'],
      $product['sku'],
      $product['price']);
  }
}

/**
 * Gets MailChimp product values from an Ubercart product node.
 *
 * @param object $node
 *   The Ubercart 'product' type node.
 *
 * @return array
 *   Array of product values for use with MailChimp.
 */
function mailchimp_ecommerce_ubercart_get_product_values_from_node($node) {
  $node_wrapper = entity_metadata_wrapper('node', $node);

  $product = array(
    'id' => $node_wrapper->nid->value(),
    'variant_id' => $node_wrapper->model->value(),
    'sku' => $node_wrapper->model->value(),
    'title' => $node_wrapper->title->value(),
    'description' => (isset($node_wrapper->body->value()['value'])) ? $node_wrapper->body->value()['value'] : '',
    'price' => $node_wrapper->sell_price->value(),
    // TODO: Ubercart product types.
    'type' => '',
  );

  return $product;
}

// TODO: Implement mailchimp_ecommerce_add_customer()
// TODO: Implement mailchimp_ecommerce_update_customer()
// TODO: Implement mailchimp_ecommerce_delete_customer()
// TODO: Implement mailchimp_ecommerce_get_customer()
// TODO: Implement mailchimp_ecommerce_add_cart()
// TODO: Implement mailchimp_ecommerce_update_cart()
// TODO: Implement mailchimp_ecommerce_delete_cart()
// TODO: Implement mailchimp_ecommerce_add_order()
// TODO: Implement mailchimp_ecommerce_delete_product_variant()
